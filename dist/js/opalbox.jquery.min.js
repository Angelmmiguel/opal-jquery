/*
 * Generate an HTML box to write ruby code an execute it on output.
 * This plugin uses http://opalrb.org/ to compile the Ruby code into
 * javascript.
 *
 * @author Angel M (@laux_es)
 * @version 0.0.2rc
 * @license MIT License
 */
!function($,window,document,undefined){function OpalBox(t,e){this.element=t,this._name=pluginName,this._defaults=$.fn.opalBox.defaults,this.options=$.extend({},this._defaults,e),this.init()}var pluginName="opalBox";$.extend(OpalBox.prototype,{init:function(){this._createBox(),this._buildCache(),this._bindEvents()},destroy:function(){this._unbindEvents(),this.$element.removeData()},_createBox:function(){this.$element=$(this.element),this.code=this.$element.text(),this.$element.addClass(this.options.theme+" opbox"),this.$element.html(""),this.$element.append(this._baseHTML())},_baseHTML:function(){return'<div class="opbox-header">'+this.options.title+'</div><div class="opbox-code-wrap"><textarea class="opbox-code">'+this.code+'</textarea></div><div class="opbox-output"><div class="opbox-execute"><button class="opbox-run">Run</button><div class="opbox-loader"></div><div class="opbox-loader delayed"></div></div><div class="opbox-result"><p class="empty">'+this.options.result+"</p></div></div>"},_buildCache:function(){this.$execute=this.$element.find(".opbox-run"),this.$loader=this.$element.find(".opbox-loader"),this.$code=this.$element.find(".opbox-code"),this.$result=this.$element.find(".opbox-result"),this.standardLog=window.console.log},_bindEvents:function(){var t=this;t.$execute.on("click."+t._name,function(){t.execute.call(t)}),t.options.autoadjust&&(t.$code.on("input",function(){$(this).height(this.scrollHeight-25)}),t.$code.trigger("input"))},unbindEvents:function(){this.$execute.off("."+this._name)},compile:function(){return Opal.compile(this.$code.val())},execute:function(){this._setButtonLoading();var compiled=this.compile(),error,res;this.$result.html("Executing the code...");try{var self=this;window.console.log=function(t){self._showResult(t)},res=eval(compiled)}catch(compiled_error){error=compiled_error.message}window.console.log=this.standardLog,error===undefined?this._showResult(res):this._showResult(error,!0),this._setButtonRun(),this.callback()},_setButtonLoading:function(){this.$execute.html(""),this.$loader.show()},_setButtonRun:function(){this.$loader.hide(),this.$execute.html("Run")},_showResult:function(t,e){this.$result.append(e===!0?"<p class='opbox-error'>"+t+"</p>":"<p>"+t+"</p>")},callback:function(){var t=this.options.onComplete;"function"==typeof t&&t.call(this.element)}}),$.fn.opalBox=function(t){return this.each(function(){$.data(this,"plugin_"+pluginName)||$.data(this,"plugin_"+pluginName,new OpalBox(this,t))}),this},$.fn.opalBox.defaults={theme:"light",onComplete:null,title:"Ruby code",result:"Result will appear here",autoadjust:!1}}(jQuery,window,document);